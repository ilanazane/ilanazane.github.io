<!DOCTYPE html>
<html lang="en"><head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Feature Engineering for Alpha Factor Research | Ilana Zane</title>
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="Feature Engineering for Alpha Factor Research" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Alpha factors are mathematical expressions or models that aim to quantify the skill of an investment strategy in generating excess returns beyond what would be expected given the associated risks i.e. it represents the active return of a portfolio." />
<meta property="og:description" content="Alpha factors are mathematical expressions or models that aim to quantify the skill of an investment strategy in generating excess returns beyond what would be expected given the associated risks i.e. it represents the active return of a portfolio." />
<link rel="canonical" href="http://localhost:4000/2024/02/19/feature_engineering.html" />
<meta property="og:url" content="http://localhost:4000/2024/02/19/feature_engineering.html" />
<meta property="og:site_name" content="Ilana Zane" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-02-19T00:00:00-05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Feature Engineering for Alpha Factor Research" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-02-19T00:00:00-05:00","datePublished":"2024-02-19T00:00:00-05:00","description":"Alpha factors are mathematical expressions or models that aim to quantify the skill of an investment strategy in generating excess returns beyond what would be expected given the associated risks i.e. it represents the active return of a portfolio.","headline":"Feature Engineering for Alpha Factor Research","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2024/02/19/feature_engineering.html"},"url":"http://localhost:4000/2024/02/19/feature_engineering.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Ilana Zane" /><meta name="google-site-verification" content="-U80l7j-jWyXzli0lOaeIKs8E0K3Rs2hUzeXIwJeoaw" />
  </head>

  <script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    processEscapes: true
  }
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script><body><header class="site-header" role="banner">

    <div class="wrapper"><a class="site-title" rel="author" href="/">Ilana Zane</a><nav class="site-nav">
          <input type="checkbox" id="nav-trigger" class="nav-trigger" />
          <label for="nav-trigger">
            <span class="menu-icon">
              <svg viewBox="0 0 18 15" width="18px" height="15px">
                <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
              </svg>
            </span>
          </label>
  
          <div class="trigger"><a class="page-link" href="/about/">About</a><a class="page-link" href="/categories/">Categories</a><a class="page-link" href="/research/">Research</a></div>
        </nav><!-- <img src="/assets/images/banner2.png"/> -->
    </div>
  </header>
  <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Feature Engineering for Alpha Factor Research</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2024-02-19T00:00:00-05:00" itemprop="datePublished">Feb 19, 2024
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Alpha factors are mathematical expressions or models that aim to quantify the skill of an investment strategy in generating excess returns beyond what would be expected given the associated risks i.e. it represents the active return of a portfolio.</p>

<p>Here is the data that we are going to use:</p>

<p>The wiki prices is a NASDAQ dataset that has stock prices, dividends, and splits for 3000 US publicly-traded companies
<a href="https://data.nasdaq.com/tables/WIKIP/WIKI-PRICES/export">wiki prices data</a></p>

<p>The US Equities Meta-Data can be found on my github. Beware it is a large file ~1.8 GB. 
<a href="https://github.com/ilanazane/ML-for-Algorithmic-Trading/tree/main/Feature-Engineering">us equities meta data</a></p>

<h2 id="imports">Imports</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%</span><span class="n">pip</span> <span class="n">install</span> <span class="n">pandas_datareader</span>
<span class="o">%</span><span class="n">pip</span> <span class="n">install</span> <span class="n">statsmodels</span>

</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">warnings</span>
<span class="n">warnings</span><span class="p">.</span><span class="nf">filterwarnings</span><span class="p">(</span><span class="sh">'</span><span class="s">ignore</span><span class="sh">'</span><span class="p">)</span>

<span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="n">pandas_datareader.data</span> <span class="k">as</span> <span class="n">web</span>

<span class="kn">import</span> <span class="n">seaborn</span> <span class="k">as</span> <span class="n">sns</span>

<span class="kn">from</span> <span class="n">statsmodels.regression.rolling</span> <span class="kn">import</span> <span class="n">RollingOLS</span>

<span class="kn">import</span> <span class="n">statsmodels.api</span> <span class="k">as</span> <span class="n">sm</span>

<span class="kn">from</span> <span class="n">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">START</span> <span class="o">=</span> <span class="mi">2000</span>
<span class="n">END</span> <span class="o">=</span> <span class="mi">2018</span>

<span class="n">idx</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">IndexSlice</span>
</code></pre></div></div>
<h2 id="read-and-store-data">Read and Store Data</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># parse prices data 
</span>
<span class="n">df_prices</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">WIKI_PRICES.csv</span><span class="sh">'</span><span class="p">,</span>
                 <span class="n">parse_dates</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">date</span><span class="sh">'</span><span class="p">],</span>
                 <span class="n">index_col</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">date</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">ticker</span><span class="sh">'</span><span class="p">],</span>
                 <span class="n">infer_datetime_format</span><span class="o">=</span><span class="bp">True</span><span class="p">)).</span><span class="nf">sort_index</span><span class="p">()</span>

<span class="n">df_screener</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">us_equities_meta_data.csv</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># store price and stock data 
</span>
<span class="k">with</span> <span class="n">pd</span><span class="p">.</span><span class="nc">HDFStore</span><span class="p">(</span><span class="sh">'</span><span class="s">assets.h5</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">store</span><span class="p">:</span>
    <span class="n">store</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="sh">'</span><span class="s">data_prices</span><span class="sh">'</span><span class="p">,</span><span class="n">df_prices</span><span class="p">)</span>
    <span class="n">store</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="sh">'</span><span class="s">data_screener</span><span class="sh">'</span><span class="p">,</span><span class="n">df_screener</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># read in prices and stocks 
</span><span class="sh">'''</span><span class="s">
get all the dates between START and END and 
then get the adj_close column 
reshape df by turning the tickers into the columns and have the adj value for every date 
we convert the rows into columns so that we can easily access the tickers later on 
</span><span class="sh">'''</span>


<span class="k">with</span> <span class="n">pd</span><span class="p">.</span><span class="nc">HDFStore</span><span class="p">(</span><span class="sh">'</span><span class="s">assets.h5</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">store</span><span class="p">:</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="p">(</span><span class="n">store</span><span class="p">[</span><span class="sh">'</span><span class="s">data_prices</span><span class="sh">'</span><span class="p">]</span>
              <span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="n">START</span><span class="p">):</span><span class="nf">str</span><span class="p">(</span><span class="n">END</span><span class="p">),</span> <span class="p">:],</span> <span class="sh">'</span><span class="s">adj_close</span><span class="sh">'</span><span class="p">]</span>
              <span class="p">.</span><span class="nf">unstack</span><span class="p">(</span><span class="sh">'</span><span class="s">ticker</span><span class="sh">'</span><span class="p">))</span>
    <span class="n">stocks</span> <span class="o">=</span> <span class="n">store</span><span class="p">[</span><span class="sh">'</span><span class="s">data_screener</span><span class="sh">'</span><span class="p">].</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="sh">'</span><span class="s">ticker</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">marketcap</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">ipoyear</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">sector</span><span class="sh">'</span><span class="p">]]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">prices</span><span class="p">.</span><span class="nf">info</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
DatetimeIndex: 4706 entries, 2000-01-03 to 2018-03-27
Columns: 3199 entries, A to ZUMZ
dtypes: float64(3199)
memory usage: 114.9 MB
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">stocks</span><span class="p">.</span><span class="nf">info</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
Int64Index: 6834 entries, 0 to 6833
Data columns (total 4 columns):
 #   Column     Non-Null Count  Dtype  
---  ------     --------------  -----  
 0   ticker     6834 non-null   object 
 1   marketcap  5766 non-null   float64
 2   ipoyear    3038 non-null   float64
 3   sector     5288 non-null   object 
dtypes: float64(2), object(2)
memory usage: 267.0+ KB
</code></pre></div></div>

<h2 id="data-cleaning">Data Cleaning</h2>
<p>remove stock duplicates and reset the index name for later data manipulation</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">stocks</span> <span class="o">=</span> <span class="n">stocks</span><span class="p">[</span><span class="o">~</span><span class="n">stocks</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="nf">duplicated</span><span class="p">()]</span>
<span class="n">stocks</span> <span class="o">=</span> <span class="n">stocks</span><span class="p">.</span><span class="nf">set_index</span><span class="p">(</span><span class="sh">'</span><span class="s">ticker</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<p>get all of the common tickers with their price information and metadata</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">shared</span> <span class="o">=</span> <span class="n">prices</span><span class="p">.</span><span class="n">columns</span><span class="p">.</span><span class="nf">intersection</span><span class="p">(</span><span class="n">stocks</span><span class="p">.</span><span class="n">index</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">stocks</span> <span class="o">=</span> <span class="n">stocks</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">shared</span><span class="p">,</span> <span class="p">:]</span>
<span class="n">stocks</span><span class="p">.</span><span class="nf">info</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
Index: 2412 entries, A to ZUMZ
Data columns (total 3 columns):
 #   Column     Non-Null Count  Dtype  
---  ------     --------------  -----  
 0   marketcap  2407 non-null   float64
 1   ipoyear    1065 non-null   float64
 2   sector     2372 non-null   object 
dtypes: float64(2), object(1)
memory usage: 75.4+ KB
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span><span class="p">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">shared</span><span class="p">]</span>
<span class="n">prices</span><span class="p">.</span><span class="nf">info</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
DatetimeIndex: 4706 entries, 2000-01-03 to 2018-03-27
Columns: 2412 entries, A to ZUMZ
dtypes: float64(2412)
memory usage: 86.6 MB
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">assert</span> <span class="n">prices</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">stocks</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></div>

<h2 id="create-a-monthly-return-series">Create a Monthly Return Series</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">monthly_prices</span> <span class="o">=</span> <span class="n">prices</span><span class="p">.</span><span class="nf">resample</span><span class="p">(</span><span class="sh">'</span><span class="s">M</span><span class="sh">'</span><span class="p">).</span><span class="nf">last</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">monthly_prices</span><span class="p">.</span><span class="nf">info</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
DatetimeIndex: 219 entries, 2000-01-31 to 2018-03-31
Freq: M
Columns: 2412 entries, A to ZUMZ
dtypes: float64(2412)
memory usage: 4.0 MB
</code></pre></div></div>

<p>Here, we calculate the precentage change of monthly prices over a lag period. This represents the return over the specified number of months.</p>

<p>Clip outliers in the data based on the <code class="language-plaintext highlighter-rouge">outlier_cutoff</code> quantile and the <code class="language-plaintext highlighter-rouge">1- outlier_cutoff</code> to their respective quantile values. Add 1 to the clipped values. This is to handle returns and convert percentage changes back to absolute returns.</p>

<p>Raise each value to the power of \(\frac{1}{lag}\). This is used to annualize returns when the lag is representative of months.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">outlier_cutoff</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">()</span>
<span class="n">lags</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">12</span><span class="p">]</span>
<span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="n">lags</span><span class="p">:</span>
    <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="sh">'</span><span class="s">return_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s">m</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">monthly_prices</span>
                           <span class="p">.</span><span class="nf">pct_change</span><span class="p">(</span><span class="n">lag</span><span class="p">)</span> 
                           <span class="p">.</span><span class="nf">stack</span><span class="p">()</span>         
                           <span class="p">.</span><span class="nf">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">.</span><span class="nf">clip</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="n">x</span><span class="p">.</span><span class="nf">quantile</span><span class="p">(</span><span class="n">outlier_cutoff</span><span class="p">),</span>
                                                  <span class="n">upper</span><span class="o">=</span><span class="n">x</span><span class="p">.</span><span class="nf">quantile</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">outlier_cutoff</span><span class="p">)))</span> 
                           <span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                           <span class="p">.</span><span class="nf">pow</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">lag</span><span class="p">)</span>
                           <span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                           <span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">swaplevel</span><span class="p">().</span><span class="nf">dropna</span><span class="p">()</span>
<span class="n">data</span><span class="p">.</span><span class="nf">info</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
MultiIndex: 399525 entries, ('A', Timestamp('2001-01-31 00:00:00', freq='M')) to ('ZUMZ', Timestamp('2018-03-31 00:00:00', freq='M'))
Data columns (total 6 columns):
 #   Column      Non-Null Count   Dtype  
---  ------      --------------   -----  
 0   return_1m   399525 non-null  float64
 1   return_2m   399525 non-null  float64
 2   return_3m   399525 non-null  float64
 3   return_6m   399525 non-null  float64
 4   return_9m   399525 non-null  float64
 5   return_12m  399525 non-null  float64
dtypes: float64(6)
memory usage: 19.9+ MB
</code></pre></div></div>

<h2 id="drop-stocks-with-less-than-10-years-of-returns">Drop Stocks with Less than 10 Years of Returns</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">min_obs</span> <span class="o">=</span> <span class="mi">120</span>

<span class="c1"># get the number of observations for each ticker 
</span><span class="n">nobs</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="sh">'</span><span class="s">ticker</span><span class="sh">'</span><span class="p">).</span><span class="nf">size</span><span class="p">()</span>

<span class="c1"># get the indices of the tickers where the num of observations is greater than min_obs
</span><span class="n">keep</span> <span class="o">=</span> <span class="n">nobs</span><span class="p">[</span><span class="n">nobs</span><span class="o">&gt;</span><span class="n">min_obs</span><span class="p">].</span><span class="n">index</span>

<span class="c1"># get the data with appropriate tickers and their respective data 
</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="n">keep</span><span class="p">,:],</span> <span class="p">:]</span>
<span class="n">data</span><span class="p">.</span><span class="nf">info</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
MultiIndex: 360752 entries, ('A', Timestamp('2001-01-31 00:00:00', freq='M')) to ('ZUMZ', Timestamp('2018-03-31 00:00:00', freq='M'))
Data columns (total 6 columns):
 #   Column      Non-Null Count   Dtype  
---  ------      --------------   -----  
 0   return_1m   360752 non-null  float64
 1   return_2m   360752 non-null  float64
 2   return_3m   360752 non-null  float64
 3   return_6m   360752 non-null  float64
 4   return_9m   360752 non-null  float64
 5   return_12m  360752 non-null  float64
dtypes: float64(6)
memory usage: 18.0+ MB
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data</span><span class="p">.</span><span class="nf">describe</span><span class="p">()</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>return_1m</th>
      <th>return_2m</th>
      <th>return_3m</th>
      <th>return_6m</th>
      <th>return_9m</th>
      <th>return_12m</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>360752.000000</td>
      <td>360752.000000</td>
      <td>360752.000000</td>
      <td>360752.000000</td>
      <td>360752.000000</td>
      <td>360752.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>0.012255</td>
      <td>0.009213</td>
      <td>0.008181</td>
      <td>0.007025</td>
      <td>0.006552</td>
      <td>0.006296</td>
    </tr>
    <tr>
      <th>std</th>
      <td>0.114236</td>
      <td>0.081170</td>
      <td>0.066584</td>
      <td>0.048474</td>
      <td>0.039897</td>
      <td>0.034792</td>
    </tr>
    <tr>
      <th>min</th>
      <td>-0.329564</td>
      <td>-0.255452</td>
      <td>-0.214783</td>
      <td>-0.162063</td>
      <td>-0.131996</td>
      <td>-0.114283</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>-0.046464</td>
      <td>-0.030716</td>
      <td>-0.023961</td>
      <td>-0.014922</td>
      <td>-0.011182</td>
      <td>-0.009064</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>0.009448</td>
      <td>0.009748</td>
      <td>0.009744</td>
      <td>0.009378</td>
      <td>0.008982</td>
      <td>0.008726</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>0.066000</td>
      <td>0.049249</td>
      <td>0.042069</td>
      <td>0.031971</td>
      <td>0.027183</td>
      <td>0.024615</td>
    </tr>
    <tr>
      <th>max</th>
      <td>0.430943</td>
      <td>0.281819</td>
      <td>0.221789</td>
      <td>0.154555</td>
      <td>0.124718</td>
      <td>0.106371</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sns</span><span class="p">.</span><span class="nf">clustermap</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">corr</span><span class="p">(</span><span class="sh">'</span><span class="s">spearman</span><span class="sh">'</span><span class="p">),</span> <span class="n">annot</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="sh">'</span><span class="s">Blues</span><span class="sh">'</span><span class="p">);</span>
</code></pre></div></div>

<p><img src="http://localhost:4000/assets/images/feature_engineering_files/feature_engineering_26_0.png" alt="image" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="nf">get_level_values</span><span class="p">(</span><span class="sh">'</span><span class="s">ticker</span><span class="sh">'</span><span class="p">).</span><span class="nf">nunique</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1838
</code></pre></div></div>

<h2 id="rolling-factor-betas">Rolling Factor Betas</h2>

<p>In this section we are going to estimate the factor exposure of the listed stocks in the database according to the Fama-French Five-Factor Model.</p>

<p><code class="language-plaintext highlighter-rouge">Mkt-Rf</code> is the market risk premium \((R_m - R_f)\). The difference between these two factors represents the additional return investors demand for bearing the systemic risk associated with the market.</p>

<p><code class="language-plaintext highlighter-rouge">SMB</code> is small minus big. This factor represents the spread between small-cap and large-cap stocks.</p>

<p>SMB is typically measured in terms of market capitalization which is represented as \(MarketCapitalization = currentStockPrice * TotalNumberOfOutstandingShares\)</p>

<p><code class="language-plaintext highlighter-rouge">HML</code> is high minus low, which is the spread between high book-to-market and low book-to-market stocks. The book-to-market ratio is \(\frac{shareholder'sEquity}{marketCapitalization}\).</p>

<p><code class="language-plaintext highlighter-rouge">RMW</code> is robust minus weak. This compares the returns of firms with higher operating profitability and those with weak operating probitability</p>

<p><code class="language-plaintext highlighter-rouge">CMA</code> is conservative minus aggressive and it gauges the difference between companies that invest aggressively and those that do so more conservatively.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">factors</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">Mkt-RF</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">SMB</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">HML</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">RMW</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">CMA</span><span class="sh">'</span><span class="p">]</span>
<span class="n">factor_data</span> <span class="o">=</span> <span class="n">web</span><span class="p">.</span><span class="nc">DataReader</span><span class="p">(</span><span class="sh">'</span><span class="s">F-F_Research_Data_5_Factors_2x3</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">famafrench</span><span class="sh">'</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="sh">'</span><span class="s">2000</span><span class="sh">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nf">drop</span><span class="p">(</span><span class="sh">'</span><span class="s">RF</span><span class="sh">'</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">factor_data</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">factor_data</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="nf">to_timestamp</span><span class="p">()</span>
<span class="n">factor_data</span> <span class="o">=</span> <span class="n">factor_data</span><span class="p">.</span><span class="nf">resample</span><span class="p">(</span><span class="sh">'</span><span class="s">M</span><span class="sh">'</span><span class="p">).</span><span class="nf">last</span><span class="p">().</span><span class="nf">div</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">factor_data</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sh">'</span><span class="s">date</span><span class="sh">'</span>
<span class="n">factor_data</span><span class="p">.</span><span class="nf">info</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
DatetimeIndex: 289 entries, 2000-01-31 to 2024-01-31
Freq: M
Data columns (total 5 columns):
 #   Column  Non-Null Count  Dtype  
---  ------  --------------  -----  
 0   Mkt-RF  289 non-null    float64
 1   SMB     289 non-null    float64
 2   HML     289 non-null    float64
 3   RMW     289 non-null    float64
 4   CMA     289 non-null    float64
dtypes: float64(5)
memory usage: 13.5 KB
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">factor_data</span> <span class="o">=</span> <span class="n">factor_data</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">return_1m</span><span class="sh">'</span><span class="p">]).</span><span class="nf">sort_index</span><span class="p">()</span>
<span class="n">factor_data</span><span class="p">.</span><span class="nf">info</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
MultiIndex: 360752 entries, ('A', Timestamp('2001-01-31 00:00:00', freq='M')) to ('ZUMZ', Timestamp('2018-03-31 00:00:00', freq='M'))
Data columns (total 6 columns):
 #   Column     Non-Null Count   Dtype  
---  ------     --------------   -----  
 0   Mkt-RF     360752 non-null  float64
 1   SMB        360752 non-null  float64
 2   HML        360752 non-null  float64
 3   RMW        360752 non-null  float64
 4   CMA        360752 non-null  float64
 5   return_1m  360752 non-null  float64
dtypes: float64(6)
memory usage: 18.0+ MB
</code></pre></div></div>

<p>Unlike traditional linear regression that considers an entire dataset, rolling linear regression calculates regresion coefficients and other statistics for a specified window of consecutive data points and then moves a window forward one observation at a time. 
Rolling Linear Regression is helpful when delaing with non-stationary time series data.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">T</span> <span class="o">=</span> <span class="mi">24</span>
<span class="n">betas</span> <span class="o">=</span> <span class="p">(</span><span class="n">factor_data</span><span class="p">.</span><span class="nf">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="sh">'</span><span class="s">ticker</span><span class="sh">'</span><span class="p">,</span>
                             <span class="n">group_keys</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
         <span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nc">RollingOLS</span><span class="p">(</span><span class="n">endog</span><span class="o">=</span><span class="n">x</span><span class="p">.</span><span class="n">return_1m</span><span class="p">,</span>
                                     <span class="n">exog</span><span class="o">=</span><span class="n">sm</span><span class="p">.</span><span class="nf">add_constant</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="sh">'</span><span class="s">return_1m</span><span class="sh">'</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span>
                                     <span class="n">window</span><span class="o">=</span><span class="nf">min</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">x</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                <span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">params_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="p">.</span><span class="n">params</span>
                <span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="sh">'</span><span class="s">const</span><span class="sh">'</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">betas</span><span class="p">.</span><span class="nf">describe</span><span class="p">().</span><span class="nf">join</span><span class="p">(</span><span class="n">betas</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nf">describe</span><span class="p">().</span><span class="nf">to_frame</span><span class="p">(</span><span class="sh">'</span><span class="s">total</span><span class="sh">'</span><span class="p">))</span>

</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Mkt-RF</th>
      <th>SMB</th>
      <th>HML</th>
      <th>RMW</th>
      <th>CMA</th>
      <th>total</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>318478.000000</td>
      <td>318478.000000</td>
      <td>318478.000000</td>
      <td>318478.000000</td>
      <td>318478.000000</td>
      <td>360752.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>0.979365</td>
      <td>0.626588</td>
      <td>0.122610</td>
      <td>-0.062073</td>
      <td>0.016754</td>
      <td>1.485997</td>
    </tr>
    <tr>
      <th>std</th>
      <td>0.918116</td>
      <td>1.254249</td>
      <td>1.603524</td>
      <td>1.908446</td>
      <td>2.158982</td>
      <td>3.306487</td>
    </tr>
    <tr>
      <th>min</th>
      <td>-9.805604</td>
      <td>-10.407516</td>
      <td>-15.382504</td>
      <td>-23.159702</td>
      <td>-18.406854</td>
      <td>-33.499590</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>0.463725</td>
      <td>-0.118767</td>
      <td>-0.707780</td>
      <td>-0.973586</td>
      <td>-1.071697</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>0.928902</td>
      <td>0.541623</td>
      <td>0.095292</td>
      <td>0.037585</td>
      <td>0.040641</td>
      <td>1.213499</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>1.444882</td>
      <td>1.304325</td>
      <td>0.946760</td>
      <td>0.950267</td>
      <td>1.135600</td>
      <td>3.147199</td>
    </tr>
    <tr>
      <th>max</th>
      <td>10.855709</td>
      <td>10.297453</td>
      <td>15.038572</td>
      <td>17.079472</td>
      <td>16.671709</td>
      <td>34.259432</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cmap</span> <span class="o">=</span> <span class="n">sns</span><span class="p">.</span><span class="nf">diverging_palette</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">220</span><span class="p">,</span><span class="n">as_cmap</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">clustermap</span><span class="p">(</span><span class="n">betas</span><span class="p">.</span><span class="nf">corr</span><span class="p">(),</span><span class="n">annot</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span>
</code></pre></div></div>

<p><img src="http://localhost:4000/assets/images/feature_engineering_files/feature_engineering_33_0.png" alt="image" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">betas</span><span class="p">.</span><span class="nf">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="sh">'</span><span class="s">ticker</span><span class="sh">'</span><span class="p">).</span><span class="nf">shift</span><span class="p">()))</span>
<span class="n">data</span><span class="p">.</span><span class="nf">info</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
MultiIndex: 360752 entries, ('A', Timestamp('2001-01-31 00:00:00', freq='M')) to ('ZUMZ', Timestamp('2018-03-31 00:00:00', freq='M'))
Data columns (total 11 columns):
 #   Column      Non-Null Count   Dtype  
---  ------      --------------   -----  
 0   return_1m   360752 non-null  float64
 1   return_2m   360752 non-null  float64
 2   return_3m   360752 non-null  float64
 3   return_6m   360752 non-null  float64
 4   return_9m   360752 non-null  float64
 5   return_12m  360752 non-null  float64
 6   Mkt-RF      316640 non-null  float64
 7   SMB         316640 non-null  float64
 8   HML         316640 non-null  float64
 9   RMW         316640 non-null  float64
 10  CMA         316640 non-null  float64
dtypes: float64(11)
memory usage: 39.8+ MB
</code></pre></div></div>

<h2 id="impute-mean-for-missing-factor-betas">Impute Mean for Missing Factor Betas</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data</span><span class="p">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">factors</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">groupby</span><span class="p">(</span><span class="sh">'</span><span class="s">ticker</span><span class="sh">'</span><span class="p">)[</span><span class="n">factors</span><span class="p">].</span><span class="nf">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">.</span><span class="nf">fillna</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="nf">mean</span><span class="p">()))</span>
<span class="n">data</span><span class="p">.</span><span class="nf">info</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
MultiIndex: 360752 entries, ('A', Timestamp('2001-01-31 00:00:00', freq='M')) to ('ZUMZ', Timestamp('2018-03-31 00:00:00', freq='M'))
Data columns (total 11 columns):
 #   Column      Non-Null Count   Dtype  
---  ------      --------------   -----  
 0   return_1m   360752 non-null  float64
 1   return_2m   360752 non-null  float64
 2   return_3m   360752 non-null  float64
 3   return_6m   360752 non-null  float64
 4   return_9m   360752 non-null  float64
 5   return_12m  360752 non-null  float64
 6   Mkt-RF      360752 non-null  float64
 7   SMB         360752 non-null  float64
 8   HML         360752 non-null  float64
 9   RMW         360752 non-null  float64
 10  CMA         360752 non-null  float64
dtypes: float64(11)
memory usage: 39.8+ MB
</code></pre></div></div>

<h2 id="momentum-factors">Momentum Factors</h2>

<p>Momentum represents the speed or velocity in which prices change in a publicly traded security. Momentum is caluclated by taking the return of the equal weighted average of the 30% highest performing stocks minus the return of the equal weighted average of the 30% lowest performing stocks.</p>

<p>Here, we create multiple momentum factors based on different lag periods and an additional momentum factor based on the difference between the 12 month and 3 month returns.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">12</span><span class="p">]:</span>
    <span class="c1"># for each value in the loop, calculate new column
</span>    <span class="c1"># momentum is computed as the difference between the return for that lag period 
</span>    <span class="c1"># and the reutrn for the most recent month 
</span>    <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="sh">'</span><span class="s">momentum_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="sh">'</span><span class="s">return_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s">m</span><span class="sh">'</span><span class="p">].</span><span class="nf">sub</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">return_1m</span><span class="p">)</span>
    
<span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="sh">'</span><span class="s">momentum_3_12</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="sh">'</span><span class="s">return_12m</span><span class="sh">'</span><span class="p">].</span><span class="nf">sub</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">return_3m</span><span class="p">)</span>

</code></pre></div></div>

<h2 id="date-indicators">Date Indicators</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># date indicators 
</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="nf">get_level_values</span><span class="p">(</span><span class="sh">'</span><span class="s">date</span><span class="sh">'</span><span class="p">)</span>
<span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">year</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">dates</span><span class="p">.</span><span class="n">year</span> 
<span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">month</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">dates</span><span class="p">.</span><span class="n">month</span>
</code></pre></div></div>

<h2 id="lagged-returns">Lagged Returns</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># to use lagged values as input variables or features associated with the current observations 
# we use the shift function to move historical returns up to the current period 
</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">):</span>
    <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="sh">'</span><span class="s">return_1m_t-</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="sh">'</span><span class="s">ticker</span><span class="sh">'</span><span class="p">).</span><span class="n">return_1m</span><span class="p">.</span><span class="nf">shift</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data</span><span class="p">.</span><span class="nf">info</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
MultiIndex: 360752 entries, ('A', Timestamp('2001-01-31 00:00:00', freq='M')) to ('ZUMZ', Timestamp('2018-03-31 00:00:00', freq='M'))
Data columns (total 25 columns):
 #   Column         Non-Null Count   Dtype  
---  ------         --------------   -----  
 0   return_1m      360752 non-null  float64
 1   return_2m      360752 non-null  float64
 2   return_3m      360752 non-null  float64
 3   return_6m      360752 non-null  float64
 4   return_9m      360752 non-null  float64
 5   return_12m     360752 non-null  float64
 6   Mkt-RF         360752 non-null  float64
 7   SMB            360752 non-null  float64
 8   HML            360752 non-null  float64
 9   RMW            360752 non-null  float64
 10  CMA            360752 non-null  float64
 11  momentum_2     360752 non-null  float64
 12  momentum_3     360752 non-null  float64
 13  momentum_6     360752 non-null  float64
 14  momentum_9     360752 non-null  float64
 15  momentum_12    360752 non-null  float64
 16  momentum_3_12  360752 non-null  float64
 17  year           360752 non-null  int64  
 18  month          360752 non-null  int64  
 19  return_1m_t-1  358914 non-null  float64
 20  return_1m_t-2  357076 non-null  float64
 21  return_1m_t-3  355238 non-null  float64
 22  return_1m_t-4  353400 non-null  float64
 23  return_1m_t-5  351562 non-null  float64
 24  return_1m_t-6  349724 non-null  float64
dtypes: float64(23), int64(2)
memory usage: 78.3+ MB
</code></pre></div></div>

<h2 id="target-holding-period-returns">Target: Holding Period Returns</h2>

<p>Holding period returns are the total return an investor earns or loses from holding an investment over a specific period of time. \(HPR = \frac{(endingValue - beginningValue + income)}{beginningValue}*100\%\)</p>

<p>Use the normalized period returns computed previously and shift them back to align them with the current financial features</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">12</span><span class="p">]:</span>
    <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="sh">'</span><span class="s">target_</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s">m</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="sh">'</span><span class="s">ticker</span><span class="sh">'</span><span class="p">)[</span><span class="sa">f</span><span class="sh">'</span><span class="s">return_</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s">m</span><span class="sh">'</span><span class="p">].</span><span class="nf">shift</span><span class="p">(</span><span class="o">-</span><span class="n">t</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">target_1m</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">target_2m</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">target_3m</span><span class="sh">'</span><span class="p">,</span> 
        <span class="sh">'</span><span class="s">return_1m</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">return_2m</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">return_3m</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">return_1m_t-1</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">return_1m_t-2</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">return_1m_t-3</span><span class="sh">'</span><span class="p">]</span>

<span class="n">data</span><span class="p">[</span><span class="n">cols</span><span class="p">].</span><span class="nf">dropna</span><span class="p">().</span><span class="nf">sort_index</span><span class="p">().</span><span class="nf">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>target_1m</th>
      <th>target_2m</th>
      <th>target_3m</th>
      <th>return_1m</th>
      <th>return_2m</th>
      <th>return_3m</th>
      <th>return_1m_t-1</th>
      <th>return_1m_t-2</th>
      <th>return_1m_t-3</th>
    </tr>
    <tr>
      <th>ticker</th>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="10" valign="top">A</th>
      <th>2001-04-30</th>
      <td>-0.140220</td>
      <td>-0.087246</td>
      <td>-0.098192</td>
      <td>0.269444</td>
      <td>0.040966</td>
      <td>-0.105747</td>
      <td>-0.146389</td>
      <td>-0.329564</td>
      <td>-0.003653</td>
    </tr>
    <tr>
      <th>2001-05-31</th>
      <td>-0.031008</td>
      <td>-0.076414</td>
      <td>-0.075527</td>
      <td>-0.140220</td>
      <td>0.044721</td>
      <td>-0.023317</td>
      <td>0.269444</td>
      <td>-0.146389</td>
      <td>-0.329564</td>
    </tr>
    <tr>
      <th>2001-06-30</th>
      <td>-0.119692</td>
      <td>-0.097014</td>
      <td>-0.155847</td>
      <td>-0.031008</td>
      <td>-0.087246</td>
      <td>0.018842</td>
      <td>-0.140220</td>
      <td>0.269444</td>
      <td>-0.146389</td>
    </tr>
    <tr>
      <th>2001-07-31</th>
      <td>-0.073750</td>
      <td>-0.173364</td>
      <td>-0.080114</td>
      <td>-0.119692</td>
      <td>-0.076414</td>
      <td>-0.098192</td>
      <td>-0.031008</td>
      <td>-0.140220</td>
      <td>0.269444</td>
    </tr>
    <tr>
      <th>2001-08-31</th>
      <td>-0.262264</td>
      <td>-0.083279</td>
      <td>0.009593</td>
      <td>-0.073750</td>
      <td>-0.097014</td>
      <td>-0.075527</td>
      <td>-0.119692</td>
      <td>-0.031008</td>
      <td>-0.140220</td>
    </tr>
    <tr>
      <th>2001-09-30</th>
      <td>0.139130</td>
      <td>0.181052</td>
      <td>0.134010</td>
      <td>-0.262264</td>
      <td>-0.173364</td>
      <td>-0.155847</td>
      <td>-0.073750</td>
      <td>-0.119692</td>
      <td>-0.031008</td>
    </tr>
    <tr>
      <th>2001-10-31</th>
      <td>0.224517</td>
      <td>0.131458</td>
      <td>0.108697</td>
      <td>0.139130</td>
      <td>-0.083279</td>
      <td>-0.080114</td>
      <td>-0.262264</td>
      <td>-0.073750</td>
      <td>-0.119692</td>
    </tr>
    <tr>
      <th>2001-11-30</th>
      <td>0.045471</td>
      <td>0.054962</td>
      <td>0.045340</td>
      <td>0.224517</td>
      <td>0.181052</td>
      <td>0.009593</td>
      <td>0.139130</td>
      <td>-0.262264</td>
      <td>-0.073750</td>
    </tr>
    <tr>
      <th>2001-12-31</th>
      <td>0.064539</td>
      <td>0.045275</td>
      <td>0.070347</td>
      <td>0.045471</td>
      <td>0.131458</td>
      <td>0.134010</td>
      <td>0.224517</td>
      <td>0.139130</td>
      <td>-0.262264</td>
    </tr>
    <tr>
      <th>2002-01-31</th>
      <td>0.026359</td>
      <td>0.073264</td>
      <td>-0.003306</td>
      <td>0.064539</td>
      <td>0.054962</td>
      <td>0.108697</td>
      <td>0.045471</td>
      <td>0.224517</td>
      <td>0.139130</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data</span><span class="p">.</span><span class="nf">info</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
MultiIndex: 360752 entries, ('A', Timestamp('2001-01-31 00:00:00', freq='M')) to ('ZUMZ', Timestamp('2018-03-31 00:00:00', freq='M'))
Data columns (total 30 columns):
 #   Column         Non-Null Count   Dtype  
---  ------         --------------   -----  
 0   return_1m      360752 non-null  float64
 1   return_2m      360752 non-null  float64
 2   return_3m      360752 non-null  float64
 3   return_6m      360752 non-null  float64
 4   return_9m      360752 non-null  float64
 5   return_12m     360752 non-null  float64
 6   Mkt-RF         360752 non-null  float64
 7   SMB            360752 non-null  float64
 8   HML            360752 non-null  float64
 9   RMW            360752 non-null  float64
 10  CMA            360752 non-null  float64
 11  momentum_2     360752 non-null  float64
 12  momentum_3     360752 non-null  float64
 13  momentum_6     360752 non-null  float64
 14  momentum_9     360752 non-null  float64
 15  momentum_12    360752 non-null  float64
 16  momentum_3_12  360752 non-null  float64
 17  year           360752 non-null  int64  
 18  month          360752 non-null  int64  
 19  return_1m_t-1  358914 non-null  float64
 20  return_1m_t-2  357076 non-null  float64
 21  return_1m_t-3  355238 non-null  float64
 22  return_1m_t-4  353400 non-null  float64
 23  return_1m_t-5  351562 non-null  float64
 24  return_1m_t-6  349724 non-null  float64
 25  target_1m      358914 non-null  float64
 26  target_2m      357076 non-null  float64
 27  target_3m      355238 non-null  float64
 28  target_6m      349724 non-null  float64
 29  target_12m     338696 non-null  float64
dtypes: float64(28), int64(2)
memory usage: 92.1+ MB
</code></pre></div></div>

<h2 id="create-age-proxy">Create Age Proxy</h2>
<p>Here, we use quintiles of the IPO year as a proxy for company age. This means dividing a set of IPOs into five groups, or quintiles, based on the year in wihch each company went public. Each quintile represents a subset of companies that went public during a specific range of years.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span>
        <span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">pd</span><span class="p">.</span><span class="nf">qcut</span><span class="p">(</span><span class="n">stocks</span><span class="p">.</span><span class="n">ipoyear</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">)))</span>
              <span class="p">.</span><span class="nf">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
              <span class="p">.</span><span class="nf">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
              <span class="p">.</span><span class="nf">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
              <span class="p">.</span><span class="nf">to_frame</span><span class="p">(</span><span class="sh">'</span><span class="s">age</span><span class="sh">'</span><span class="p">)))</span>
<span class="n">data</span><span class="p">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">age</span><span class="p">.</span><span class="nf">fillna</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="create-dynamic-size-proxy">Create Dynamic Size Proxy</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">stocks</span><span class="p">.</span><span class="nf">info</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
Index: 2412 entries, A to ZUMZ
Data columns (total 3 columns):
 #   Column     Non-Null Count  Dtype  
---  ------     --------------  -----  
 0   marketcap  2407 non-null   float64
 1   ipoyear    1065 non-null   float64
 2   sector     2372 non-null   object 
dtypes: float64(2), object(1)
memory usage: 139.9+ KB
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">size_factor</span> <span class="o">=</span> <span class="p">(</span><span class="n">monthly_prices</span>
               <span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="nf">get_level_values</span><span class="p">(</span><span class="sh">'</span><span class="s">date</span><span class="sh">'</span><span class="p">).</span><span class="nf">unique</span><span class="p">(),</span>
                    <span class="n">data</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="nf">get_level_values</span><span class="p">(</span><span class="sh">'</span><span class="s">ticker</span><span class="sh">'</span><span class="p">).</span><span class="nf">unique</span><span class="p">()]</span>
               <span class="p">.</span><span class="nf">sort_index</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
               <span class="p">.</span><span class="nf">pct_change</span><span class="p">()</span>
               <span class="p">.</span><span class="nf">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
               <span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
               <span class="p">.</span><span class="nf">cumprod</span><span class="p">())</span>
<span class="n">size_factor</span><span class="p">.</span><span class="nf">info</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
DatetimeIndex: 207 entries, 2018-03-31 to 2001-01-31
Columns: 1838 entries, A to ZUMZ
dtypes: float64(1838)
memory usage: 2.9 MB
</code></pre></div></div>

<h2 id="create-size-indicator-as-declines-per-period">Create Size Indicator as Declines per Period</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">msize</span> <span class="o">=</span> <span class="p">(</span><span class="n">size_factor</span>
         <span class="p">.</span><span class="nf">mul</span><span class="p">(</span><span class="n">stocks</span>
              <span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">size_factor</span><span class="p">.</span><span class="n">columns</span><span class="p">,</span> <span class="sh">'</span><span class="s">marketcap</span><span class="sh">'</span><span class="p">])).</span><span class="nf">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="sh">'</span><span class="s">all</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">msize</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">msize</span>
                 <span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="p">.</span><span class="nf">qcut</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">)))</span>
                        <span class="p">.</span><span class="nf">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                 <span class="p">.</span><span class="nf">stack</span><span class="p">()</span>
                 <span class="p">.</span><span class="nf">swaplevel</span><span class="p">())</span>
<span class="n">data</span><span class="p">.</span><span class="n">msize</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">msize</span><span class="p">.</span><span class="nf">fillna</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="combine-data">Combine Data</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">stocks</span><span class="p">[[</span><span class="sh">'</span><span class="s">sector</span><span class="sh">'</span><span class="p">]])</span>
<span class="n">data</span><span class="p">.</span><span class="n">sector</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">sector</span><span class="p">.</span><span class="nf">fillna</span><span class="p">(</span><span class="sh">'</span><span class="s">Unknown</span><span class="sh">'</span><span class="p">)</span>

</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data</span><span class="p">.</span><span class="nf">info</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
MultiIndex: 360752 entries, ('A', Timestamp('2001-01-31 00:00:00', freq='M')) to ('ZUMZ', Timestamp('2018-03-31 00:00:00', freq='M'))
Data columns (total 33 columns):
 #   Column         Non-Null Count   Dtype  
---  ------         --------------   -----  
 0   return_1m      360752 non-null  float64
 1   return_2m      360752 non-null  float64
 2   return_3m      360752 non-null  float64
 3   return_6m      360752 non-null  float64
 4   return_9m      360752 non-null  float64
 5   return_12m     360752 non-null  float64
 6   Mkt-RF         360752 non-null  float64
 7   SMB            360752 non-null  float64
 8   HML            360752 non-null  float64
 9   RMW            360752 non-null  float64
 10  CMA            360752 non-null  float64
 11  momentum_2     360752 non-null  float64
 12  momentum_3     360752 non-null  float64
 13  momentum_6     360752 non-null  float64
 14  momentum_9     360752 non-null  float64
 15  momentum_12    360752 non-null  float64
 16  momentum_3_12  360752 non-null  float64
 17  year           360752 non-null  int64  
 18  month          360752 non-null  int64  
 19  return_1m_t-1  358914 non-null  float64
 20  return_1m_t-2  357076 non-null  float64
 21  return_1m_t-3  355238 non-null  float64
 22  return_1m_t-4  353400 non-null  float64
 23  return_1m_t-5  351562 non-null  float64
 24  return_1m_t-6  349724 non-null  float64
 25  target_1m      358914 non-null  float64
 26  target_2m      357076 non-null  float64
 27  target_3m      355238 non-null  float64
 28  target_6m      349724 non-null  float64
 29  target_12m     338696 non-null  float64
 30  age            360752 non-null  int64  
 31  msize          360752 non-null  float64
 32  sector         360752 non-null  object 
dtypes: float64(29), int64(3), object(1)
memory usage: 100.4+ MB
</code></pre></div></div>

<h2 id="store-data">Store Data</h2>
<p>store the data into an HDF file for later use</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">pd</span><span class="p">.</span><span class="nc">HDFStore</span><span class="p">(</span><span class="sh">'</span><span class="s">engineered_features.h5</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">store</span><span class="p">:</span>
    <span class="n">store</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="sh">'</span><span class="s">engineered_features</span><span class="sh">'</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="nf">sort_index</span><span class="p">().</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">[:,</span> <span class="p">:</span><span class="nf">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">28</span><span class="p">)],</span> <span class="p">:])</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">store</span><span class="p">.</span><span class="nf">info</span><span class="p">())</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'pandas.io.pytables.HDFStore'&gt;
File path: engineered_features.h5
/engineered_features            frame        (shape-&gt;[360752,33])
</code></pre></div></div>


  </div><a class="u-url" href="/2024/02/19/feature_engineering.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Ilana Zane</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Ilana Zane</li><li><a class="u-email" href="mailto:ilanazane@comcast.net">ilanazane@comcast.net</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/ilanazane"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">ilanazane</span></a></li><li><a href="https://instagram.com/lanadelzane"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#instagram"></use></svg> <span class="username">lanadelzane</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>A blog about AI and other interests </p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
